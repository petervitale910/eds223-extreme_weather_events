---
title: "Extreme weather events"
author: 'Peter Vitale'
date: '10/26/25'
format: html
editor: visual
execute: 
  cache: true
  warning: false
  message: false
---

In this project we will examine environmental effects of Texas storms:

-   

-   

-   

I'm going to start by loading in the neccesary packages

```{r}
pacman::p_load('tidyverse', 
               'sf', 
               'here', 
               'tmap', 
               'kableExtra',
               'patchwork',
               'ggthemes',
               'stars',
               'terra')
```

```{r}
# Function to check and align CRS of two sf objects
check_crs <- function(target, reference) {
  if (st_crs(target) == st_crs(reference)) {
    message("CRSs match!")
    return(target)  # return the original object
  } else {
    warning("CRSs do not match. Transforming target to match reference...")
    target_transformed <- st_transform(target, st_crs(reference))
    return(target_transformed)
  }
}

```

### Data Aggregation

Read in the light data

```{r}
lights_07_1 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021038.h08v05.001.2021039064328.tif'))
lights_07_2 <-  read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021038.h08v06.001.2021039064329.tif'))
lights_16_1 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021047.h08v05.001.2021048091106.tif'))
lights_16_2 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021047.h08v06.001.2021048091105.tif'))

```

Read in the buildings & roads

```{r}
houses <- st_read(here::here('data', 'gis_osm_buildings_a_free_1.gpkg'),
                 query = "
    SELECT * FROM gis_osm_buildings_a_free_1
    WHERE (type IS NULL AND name IS NULL)
       OR type IN ('residential', 'apartments', 'house', 'static_caravan', 'detached')", 
    quiet = TRUE)
```

Road data
```{r}
roads <- st_read(here::here('data', 'gis_osm_roads_free_1.gpkg'),
                 query = "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'",
                 quiet = TRUE)
```


Socioeconomic layers
```{r}
st_layers(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'))

income <- st_read(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'),
                  layer = 'X19_INCOME', quiet = TRUE) %>% 
  select(c('GEOID', 'B19013e1', 'B19013m1'))

census <- st_read(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'),
                  layer = 'ACS_2019_5YR_TRACT_48_TEXAS', quiet = TRUE)
```

# Blackout mask 

```{r}

lights_7 <- st_mosaic(lights_07_1, lights_07_2)

lights_16 <- st_mosaic(lights_16_1, lights_16_2)
```

# Plot the difference in two days


```{r}
lights_before <- tm_shape(lights_7)+
  tm_polygons()

lights_after <- tm_shape(lights_16)+
  tm_polygons()

# tmap_arrange(lights_before, lights_after)
```



```{r}
huston_change <-  lights_7 - lights_16

# Reclassify: 
# Set categories for severity levels
categories <- c("No Blackout", "Unburned")

# Create reclassification matrix
rcl <- matrix(c(-Inf, 200, 1, # group 1 ranges for Enhanced Regrowth
                200, Inf, 2), # group 5 ranges for High Severity
                ncol = 3, byrow = TRUE)

# Use reclassification matrix to reclassify dNBR raster
reclassified <- classify(rast(huston_change), rcl = rcl)

reclassified[reclassified == 1] <- NA

houston_bbox <- c(xmin = -96.5, xmax = -94.5, 
              ymin = 29, ymax = 30.5)


houston_blackout <- crop(reclassified, houston_bbox)



blackout_mask <- st_as_sf(as.polygons(houston_blackout))

if (st_crs(blackout_mask)$epsg == 3083) {
  print("CRS Correct!")
} else {
  warning("CRS DOES NOT MATCH, TRANSFORMING MANUALLY")
  houston_blackout <- st_transform(blackout_mask, 3083)
}

# Join Roads

check_crs(blackout_mask, st_as_sf(roads))

roads_union <- st_union( roads) # Unify geometry

roads_buffer <- st_buffer(roads_union, 200)

blackout_final_roads <- st_intersection(blackout_mask, roads_buffer)

check_crs(houses, blackout_final_roads)

houses_simple <- st_simplify(houses, dTolerance = 15)

houston_bbox_sf <- st_as_sfc(
  st_bbox(c(xmin = -96.5, xmax = -94.5, ymin = 29, ymax = 30.5), crs = st_crs(houses))
)


check_crs(houses_simple, houston_bbox_sf)

houston_buildings <- st_filter(houses_simple, houston_bbox_sf)

# Buildings 

 blackout_buildings <- st_join(houston_buildings, blackout_final_roads, join = st_intersects)


tm_shape(blackout_buildings)+
  tm_polygons()
# census

#Left_join socioeconomic layers

#Within soceoeconomic and homes experienced blackout st_join 

# Data wrangling to summarize median income by census tract

# Map 



```

```{r}
st_geometry_type(blackout_final_roads)
st_geometry_type(houses)

st_crs(blackout_final_roads)
st_crs(houses)

st_is_valid(blackout_final_roads) %>% table()
st_is_valid(houses) %>% table()

```

