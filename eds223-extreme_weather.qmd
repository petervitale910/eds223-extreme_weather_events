---
title: "Extreme weather events"
author: 'Peter Vitale'
date: '10/26/25'
format: html
editor: visual
execute: 
  cache: true
  warning: false
  message: false
---

In this project we will examine environmental effects of Texas storms:

-   

-   

-   

I'm going to start by loading in the necessary packages


```{r}
pacman::p_load('tidyverse', 
               'sf', 
               'here', 
               'tmap', 
               'kableExtra',
               'patchwork',
               'ggthemes',
               'colorRamps',
               'stars',
               'terra')
```

In this project I am working with multiple datasets that may have different crs's. I am going to be using functions to check and manually transform the crs's of the datasets

## Create two functions

```{r}
# Function to check and align CRS of two sf objects
check_crs <- function(data1, data2) {
  if (st_crs(data1) == st_crs(data2)) {
    message("CRSs match!")
    return(data1)  # return the original object
  } else {
    warning("CRSs do not match. Transforming target to match reference...")
    data2 <- st_transform(data1, st_crs(data2))
    return(st_crs(data2))
  }
}
# This function compares the crs's of two datasets - good for checking before plotting to avoid crashes

# Function to check if we are working with espg 3083
check_3083 <- function(data) {
  if (st_crs(data)$epsg == 3083) {
    message("CRS ok")
    return(data)  # return the original object
  } else {
    warning("CRS does not conform, transforming now")
    data_transformed <- st_transform(data, st_crs(3083))
    return(data_transformed)
  }
}
# This function checks if a specific sf is in ESPG 3083 which is the Texas Centric Albers Equal Area
```

## Data import

### Light data

Each day has 2 `.tif` files

```{r}
lights_07_1 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021038.h08v05.001.2021039064328.tif'))
lights_07_2 <-  read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021038.h08v06.001.2021039064329.tif'))
lights_16_1 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021047.h08v05.001.2021048091106.tif'))
lights_16_2 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021047.h08v06.001.2021048091105.tif'))
```

### Buildings 

The buildings need a query to select all the building types including null buildings
```{r}
buildings <- st_read(here::here('data', 'gis_osm_buildings_a_free_1.gpkg'),
                 query = "
    SELECT * FROM gis_osm_buildings_a_free_1
    WHERE (type IS NULL AND name IS NULL)
       OR type IN ('residential', 'apartments', 'house', 'static_caravan', 'detached')", 
    quiet = TRUE)
```

### Road data
This query acts to select the motorways from the road layer
```{r}
roads <- st_read(here::here('data', 'gis_osm_roads_free_1.gpkg'),
                 query = "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'",
                 quiet = TRUE)
```

### Socioeconomic layers

Lastly, we will want to look at the census tracts and median income 
```{r}
st_layers(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'))

income <- st_read(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'),
                  layer = 'X19_INCOME', quiet = TRUE) %>% 
  select(c('GEOID', 
           'B19013e1', 
           'B19013m1')) # B19013e1 and B19013m1 are the median income

census <- st_read(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'),
                  layer = 'ACS_2019_5YR_TRACT_48_TEXAS', 
                  quiet = TRUE) # And the whole census data
```

# Analysis
To start this analysis we need to mosaic the two files (overlapping boundaries), then check the crs. I need to make sure that all my data are cropped to be in the Houston area so that I don't crash my computer. 

## Mosaiac the two days

```{r}

lights_7 <- st_mosaic(lights_07_1, lights_07_2)



lights_16 <- st_mosaic(lights_16_1, lights_16_2)


# Call in my two bbox's for huston, one as an st_bbox

houston_bbox <- c(xmin = -96.5, xmax = -94.5, 
              ymin = 29, ymax = 30.5)

houston_bbox_sf <- st_bbox(c(xmin = -96.5, xmax = -94.5, 
              ymin = 29, ymax = 30.5), crs = "EPSG:4326")

# And crop my rasters using terra::crop

lights_7_cropped <- st_crop(lights_7, houston_bbox_sf)

lights_16_cropped <- st_crop(lights_16, houston_bbox_sf)
```

Next I am going to make a set of maps comparing night light intensities before and after the two storms


```{r}
lights_before <- tm_shape(lights_7_cropped, bbox = houston_bbox_sf) +
  tm_raster(col = names(lights_7_cropped)[1],
            col.scale = tm_scale_continuous(values = colorRampPalette(c("black", "#FAFF00"))(7))) +
  tm_legend(show = FALSE) +
  tm_title("February 7", 
           position = c("center", "top"),
           size = 1.2,
           padding = 0) +    # <- removes title box padding
 tm_compass(type = 'rose', position = c('left','bottom'), size = 3)+ # Compass Rose
tm_scalebar(position = c('left','bottom'))+
  tm_layout(frame = FALSE)


lights_after <- tm_shape(lights_16_cropped, bbox = houston_bbox_sf) +
  tm_raster(
    col = names(lights_16_cropped)[1],  # automatically grab the band name
    col.scale = tm_scale_continuous(values = colorRampPalette(c("black", "#FAFF00"))(7))
  ) +
  tm_legend(show = FALSE) +
  tm_title("February 16", 
           position = c("center", "top"),
           size = 1.2,
           padding = 0) +
  tm_layout( frame = FALSE) 


tmap_arrange(lights_before, lights_after)
```

## Now we are going to use a reclassification matrix to make blackouts and non-blackouts 

```{r}
houston_change <-  lights_7 - lights_16

houston_change[houston_change< 200] <- NA

houston_bbox <- c(xmin = -96.5, xmax = -94.5, 
              ymin = 29, ymax = 30.5)

houston_blackout <- st_crop(houston_change, houston_bbox_sf)

blackout_mask <- houston_blackout %>% 
  st_as_sf() %>% 
  st_make_valid()

blackout_mask <-check_3083(blackout_mask)
```

## Now lets buffer around the roads

## Roads

```{R}
#| warning: False
# Join Roads

roads_union <- st_union(roads) # Unify geometry

roads_buffer <- st_buffer(roads_union, 200)

roads_buffer <- check_3083(roads_buffer)

blackout_mask <-check_3083(blackout_mask)

blackout_final_roads <- st_difference(blackout_mask, roads_buffer)

# Now we need to merge on buildings

# First check that buildings is in the right format

buildings <- check_3083(buildings)

blackout_buildings <- st_intersection(buildings, blackout_final_roads)

blackout_buildings <- check_3083(blackout_buildings)
```

## Map houses in houston that lost power 

```{r}
tm_shape(blackout_buildings, bbox = houston_bbox_sf)+
  tm_polygons()+
  tm_title("Buildings that experienced a blackout in Houston, TX \n Between 2/7 and 2/16 in 2021",
           padding = 0) +
  tm_graticules()
  
```




